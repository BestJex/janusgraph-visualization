<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gremlin</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
    <style>
        .pd {
            padding: 3px;
        }

        .layui-table .layui-form {
            margin: 0px;
        }

        .layui-layer-btn .layui-layer-iframe .layui-layer-btn- .layui-layer-page {
            padding: 0px;
        }

        .layui-table-view {
            margin: 0px;
        }
    </style>
</head>
<body>

<div style="padding: 3px; background-color: #F2F2F2;">
    <div class="layui-row">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">Gremlin语句</div>
                <div class="layui-card-body pd">
                    <div><textarea id="gremlin" placeholder="请输入内容" class="layui-textarea"></textarea></div>
                </div>
                <div class="layui-card-body pd">
                    <div class="layui-row">
                        <div class="layui-col-md6 layui-col-sm6 layui-col-xs6">
                            <form class="layui-form layui-form-pane" action="">
                                <div class="layui-form-item" style="margin-bottom: 0px;padding-bottom: 5px;">
                                    <label class="layui-form-label">地址:</label>
                                    <div class="layui-input-inline">
                                        <input id="host" type="text" autocomplete="off" class="layui-input">
                                    </div>
                                    <label class="layui-form-label">端口:</label>
                                    <div class="layui-input-inline">
                                        <input id="port" type="text" autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="layui-col-md1 layui-col-md-offset5">
                            <button id="exec" type="button" class="layui-btn left">执行</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div style="padding: 3px; background-color: #F2F2F2;">
    <div class="layui-row">
        <div class="layui-col-md3" style="padding: 3px">
            <div class="layui-card">
                <div class="layui-card-header">查询结果</div>
                <div class="layui-card-body" id="result">

                </div>
            </div>
        </div>
        <div class="layui-col-md9" style="padding: 3px">
            <div class="layui-card">
                <div class="layui-card-body" id="graph">

                </div>
            </div>
        </div>
    </div>
</div>
<div class="layui-row layui-hide" id="v_data">
</div>

<div class="layui-row" style="height: 30px;padding-top: 10px;">
    <div class="layui-col-md6 layui-col-md-offset1">
        使用说明
    </div>
</div>
<script src="jquery-3.4.1.min.js" charset="utf-8"></script>
<script src="layui/layui.all.js" charset="utf-8"></script>
<script src="echarts.min.js" charset="utf-8"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script>

    function getContentSize() {
        var wh = document.documentElement.clientHeight;
        var eh = 320;
        ch = (wh - eh) + "px";
        document.getElementById("result").style.minHeight = ch;
        var c = 277;
        gh = (wh - c) + "px";
        document.getElementById("graph").style.minHeight = gh;
    }

    window.onload = getContentSize;

    // window.onresize = getContentSize;

    /*    layui.use(['element', 'layer'], function () {
            var element = layui.element;
            var layer = layui.layer;
        });*/
    var table = layui.table;

    function c_table(id, label, prop) {

        layui.use('table', function () {


            //展示已知数据
            table.render({
                id: 'edata',
                elem: '#v_table',
                cols: [
                    //标题栏
                    [{
                        field: 'key',
                        title: 'Key',
                        align: 'left'
                    }, {
                        field: 'value',
                        title: 'Value',
                        align: 'left'
                    }/*, {
                        field: 'property',
                        title: 'Property',
                        align: 'left'
                    }*/]
                ],
                data: prop,
                //,skin: 'line' //表格风格
                even: false
            });
        });
    }


    $("#host").val(Cookies.get('host'));
    $("#port").val(Cookies.get('port'));

    var index;
    $("#exec").click(function () {
        var gremlin = $("#gremlin").val().trim();
        if (gremlin.length < 3) {
            return;
        }
        var host = $("#host").val();
        var port = $("#port").val();
        Cookies.set('host', host, {expires: 7});
        Cookies.set('port', port, {expires: 7});
        $.ajax({
            type: "GET",
            contentType: "application/json;charset=UTF-8",
            //请求地址
            url: "/query",
            //数据，json字符串
            data: {host: host, port: port, gremlin: gremlin},
            dataType: "json",
            //请求成功
            success: function (result) {
                $("#result").html(result.result.replace(/\n/g, "<br/>"));
                var myChart = echarts.init(document.getElementById('graph'));
                option = {
                    title: {
                        text: ''
                    },
                    tooltip: {
                        formatter: function (param) {
                            return "id:" + param.data.id + "<br/>" + "label:" + param.data.label;
                        }
                    },
                    animationDurationUpdate: 1500,
                    animationEasingUpdate: 'quinticInOut',
                    label: {
                        normal: {
                            show: true,
                            textStyle: {
                                fontSize: 12
                            },
                        }
                    },
                    series: [
                        {
                            type: 'graph',
                            layout: 'force',
                            symbol: 'circle',
                            symbolSize: 45,
                            edgeSymbolSize: [4, 10],
                            focusNodeAdjacency: true,
                            edgeSymbol: ['circle', 'arrow'],
                            categories: [{
                                itemStyle: {
                                    normal: {
                                        color: "#009800",
                                    }
                                }
                            }],
                            roam: true,
                            label: {
                                normal: {
                                    show: true,
                                    textStyle: {
                                        fontSize: 10
                                    },
                                    formatter: function (param) {
                                        return param.data.label;
                                    }
                                }
                            },
                            force: {
                                repulsion: 1000
                            },
                            edgeLabel: {
                                normal: {
                                    show: true,
                                    textStyle: {
                                        fontSize: 10
                                    },
                                    formatter: function (param) {
                                        return param.data.label;
                                    }
                                }
                            },
                            data: result.vertices,
                            links: result.edges,
                            lineStyle: {
                                normal: {
                                    type: 'solid',
                                    opacity: 1,
                                    width: 2,
                                    curveness: 0
                                }
                            }
                        }
                    ]
                };
                // 使用刚指定的配置项和数据显示图表。
                myChart.setOption(option);

                myChart.on('click', function (params) {
                    var title = "id:" + params.data.id + ",label:" + params.data.label;
                    console.log("before" + layer.index)
                    index = layer.open({
                        id: "data_ddd",
                        title: title,
                        type: 1,
                        area: '300px',
                        btn: [],
                        shade: false,
                        anim: 1,
                        move: '.layui-layer-title',
                        offset: "r",
                        resize: false,
                        content: '<div id="tp"><table id="v_table"></table></div>',
                        success: function () {
                            c_table(params.data.id, params.data.label, params.data.properties);
                        }
                    });
                });

            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        })
    });


</script>

</body>
</html>
