<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Gremlin</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        .pd {
            padding: 3px;
        }

        .layui-layer-dialog .layui-layer-content {
            line-height: 18px;
            padding: 5px;
        }

        .layui-layer-btn {
            padding: 0px;
        }
    </style>
</head>
<body>

<div style="padding: 3px; background-color: #F2F2F2;">
    <div class="layui-row">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-header">Gremlin语句</div>
                <div class="layui-card-body pd">
                    <div><textarea id="gremlin" placeholder="请输入内容" class="layui-textarea"></textarea></div>
                </div>
                <div class="layui-card-body pd">
                    <div class="layui-row" >
                        <div class="layui-col-md6">
                            <form class="layui-form layui-form-pane" action="">
                                <div class="layui-form-item" style="margin-bottom: 0px;padding-bottom: 5px;">
                                    <label class="layui-form-label">服务器地址:</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="username" lay-verify="required" placeholder="ws://localhost"
                                               autocomplete="off" class="layui-input">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="layui-col-md1 layui-col-md-offset5">
                            <button id="exec" type="button" class="layui-btn left">执行</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div style="padding: 3px; background-color: #F2F2F2;">
    <div class="layui-row">
        <div class="layui-col-md3" style="padding: 3px">
            <div class="layui-card">
                <div class="layui-card-header">查询结果</div>
                <div class="layui-card-body" id="result">

                </div>
            </div>
        </div>
        <div class="layui-col-md9" style="padding: 3px">
            <div class="layui-card">
                <div class="layui-card-body" id="graph">

                </div>
            </div>
        </div>
    </div>
</div>

<div class="layui-row" style="height: 30px;padding-top: 10px;">
    <div class="layui-col-md6">
        服务器地址
    </div>
    <div class="layui-col-md6">
        使用说明
    </div>
</div>
<script src="jquery-3.4.1.min.js" charset="utf-8"></script>
<script src="layui/layui.all.js" charset="utf-8"></script>
<script src="echarts.min.js" charset="utf-8"></script>

<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script>
    layui.use(['element', 'layer'], function () {
        var element = layui.element;
        var layer = layui.layer;

    });

    function getContentSize() {
        var wh = document.documentElement.clientHeight;
        var eh = 320;
        ch = (wh - eh) + "px";
        document.getElementById("result").style.minHeight = ch;
        var c = 277;
        gh = (wh - c) + "px";
        document.getElementById("graph").style.minHeight = gh;
    }

    function c_table(prop) {
        var c = "<table lay-filter=\"parse-table-demo\">\n" +
            "  <thead>\n" +
            "    <tr>\n" +
            "      <th lay-data=\"{field:'Key', width:50}\">Key</th>\n" +
            "      <th lay-data=\"{field:'Value', width:150}\">Value</th>\n" +
            "      <th lay-data=\"{field:'Property', minWidth: 100}\">Property</th>\n" +
            "    </tr> \n" +
            "  </thead>"

        c += "</table>";
        return c;
    }

    function c_format(key, value, property) {
        return key + "\t" + value + "\t" + property;
    }

    window.onload = getContentSize;
    // window.onresize = getContentSize;
    $("#exec").click(function () {
        var gremlin = $("#gremlin").val().trim();
        if (gremlin.length < 3) {
            return;
        }
        $.ajax({
            type: "GET",
            contentType: "application/json;charset=UTF-8",
            //请求地址
            url: "/query",
            //数据，json字符串
            data: {host: '127.0.0.1', port: 8182, gremlin: gremlin},
            dataType: "json",
            //请求成功
            success: function (result) {
                $("#result").html(result.result.replace(/\n/g, "<br/>"));
                var myChart = echarts.init(document.getElementById('graph'));
                option = {
                    title: {
                        text: ''
                    },
                    tooltip: {
                        formatter: function (param) {
                            return "id:" + param.data.id + "<br/>" + "label:" + param.data.label;
                        }
                    },
                    animationDurationUpdate: 1500,
                    animationEasingUpdate: 'quinticInOut',
                    label: {
                        normal: {
                            show: true,
                            textStyle: {
                                fontSize: 12
                            },
                        }
                    },
                    series: [
                        {
                            type: 'graph',
                            layout: 'force',
                            symbol: 'circle',
                            symbolSize: 45,
                            edgeSymbolSize: [4, 10],
                            focusNodeAdjacency: true,
                            edgeSymbol: ['circle', 'arrow'],
                            categories: [{
                                itemStyle: {
                                    normal: {
                                        color: "#009800",
                                    }
                                }
                            }],
                            roam: true,
                            label: {
                                normal: {
                                    show: true,
                                    textStyle: {
                                        fontSize: 10
                                    },
                                    formatter: function (param) {
                                        return param.data.label;
                                    }
                                }
                            },
                            force: {
                                repulsion: 1000
                            },
                            edgeLabel: {
                                normal: {
                                    show: true,
                                    textStyle: {
                                        fontSize: 10
                                    },
                                    formatter: function (param) {
                                        return param.data.label;
                                    }
                                }
                            },
                            data: result.vertices,
                            links: result.edges,
                            lineStyle: {
                                normal: {
                                    type: 'solid',
                                    opacity: 1,
                                    width: 2,
                                    curveness: 0
                                }
                            }
                        }
                    ]
                };
                // 使用刚指定的配置项和数据显示图表。
                myChart.setOption(option);

                myChart.on('click', function (params) {
                    var c = "key\tvalue\t <hr>";
                    c += c_format("id", params.data.id, "") + "<hr>";
                    c += c_format("label", params.data.label, "<hr style='color: #00FF00'>");
                    var props = params.data.properties;
                    for (var prop in props) {
                        c += "<hr>" + c_format(prop, props[prop], "");
                    }
                    layer.closeAll();
                    layer.open({
                        id: params.data.id,
                        title: false,
                        type: 1,
                        btn: [],
                        shade: 0,
                        move: '.layui-layer-content',
                        offset: "rb",
                        content: '<div style="padding: 5px 5px;min-width: 200px">' + c + '</div>'
                    })
                });

            },
            //请求失败，包含具体的错误信息
            error: function (e) {
                console.log(e.status);
                console.log(e.responseText);
            }
        })
    });


</script>

</body>
</html>
